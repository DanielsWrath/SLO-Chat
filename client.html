<!DOCTYPE html>
<html>
<head>
<title>Chatbot Client</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.css">
<script src="http://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.js"></script> 
<link rel="stylesheet" href="chat.css">
<script src="https://cdn.rawgit.com/BrainJS/brain.js/45ce6ffc/browser.js"></script>
<script src='./bundle.js'></script>
</head>
<body>
<div data-role="page" style="background:#CCCCFF;">
    <div data-role="content">
        <div class="main-content">
            <p>Your Chat Room : <span id="room" class="namelite">&emsp;&emsp;</span></p>
            <select id="room-list" class="align-left"></select>
            <p>Your Name: <span id="name" class="namelite"></span></p>
            <div id="chat"></div>
            <br>
            <input type="text" data-clear-btn="true" id="msg">
        </div>
    </div>
</div>
</body>
<script>

  const { containerBootstrap, Nlp, LangNl, fs } = window.nlpjs;

  var container;
  var nlp;

  (async () => {
    container = await containerBootstrap();
    container.register('fs', fs);
    container.use(Nlp);
    container.use(LangNl);
    nlp = container.get('nlp');
    nlp.settings.autoSave = false;
  })();

cheating = false;
busy = false;

function clearRoom() {

    //alert("clearRoom");
    clear();
}

function deleteRoom() {
    
    //alert("deleteRoom");
    del();
}

function startCheating() {

    //alert("startCheating");    
    //cheatInterval = setInterval(sendCheat(), 3000);
    cheating = true;

    setTimeout(sendCheat, Math.round(Math.random()*parseInt($("#freq").val()))*1000);
    setTimeout(sendCheat, 0);

    /*
    cheatInterval = setInterval(function(){ 
        
        //alert("Hello"); 
        $("#msg").val(net.run(remark));
        send();

    }, 5000);
    */
    //cheatInterval = setInterval(sendCheat(), 5000);
}

function sendCheat() {

    if(busy) { return; }
    busy = true;

    try {
        
          var mess;
          var response;

          (async () => {

            response = await nlp.process('nl', remark);
            mess = response.answer;
              
            if(!(mess === undefined)) {

                $("#msg").val(mess);
                send();
            }
    
          })();

    } catch(e) { 
        
        alert(e.toString()); 

    }

    if(cheating) {

        setTimeout(sendCheat, Math.round(Math.random()*parseInt($("#freq").val()))*1000);

    }
    
    busy = false;
}

function stopCheating() {

    //alert("stopCheating");    
    cheating = false;
}

net = new brain.recurrent.LSTM();

/*
const fileSelector = document.getElementById('training-file');
fileSelector.addEventListener('change', (event) => {

	var tgt = event.target || window.event.srcElement
	files = tgt.files;
	var fr = new FileReader();
	fr.onload = () => train(fr);
	fr.readAsText(files[0]);

});
*/
    
function train(fr) {

    //alert("Start Training");
    //trainingData = eval(fr.result);

    setcorpus(chatname + ".json", fr.result);

    /*
    stats = net.train(trainingData, {
        iterations: parseInt($("#iter").val()),
        errorThresh: 0.011,
    });
    */

    //alert("End Training");
}
    
function po(o) {
		
			s = "{ ";
		
			for(var prop in o) {
			
				s += prop + ": " + o[prop] + ", ";
			
			}
			
			s = s.substring(0, s.length - 2);
			s += " }";
			
 			return s;
		
}

$(document).ready(function() { 
    chatname = prompt("Enter your chat name:", "Guest");
    if(chatname == null) { chatname = "Guest"; }
    $("#name").text(chatname);
    poll();
    get_room();
});

$('#msg').on("keyup", function(e) {           
    if (e.keyCode == 13) send();
});

$('#room-list').on("change", function() { 
    changed = $(this).find(":selected").val();
    if(changed == "create room") {
        get_room(true);
    } else {
        $("#room").text(changed);
    }
});

function send() {
    msg = $("#msg").val();
    if(msg.trim() == "") { $("#msg").val(""); return; }

    post_data = { action: "send", 
        room : $("#room").text(), 
        name: $("#name").text(), 
        msg: msg };
    //console.log(post_data);

    $.ajax({
        url: "ajax-server.php",
        type: "POST",
        data: post_data,
        success: function(r) {
            $("#chat").html(r).scrollTop($('#chat')[0].scrollHeight);
            $("#msg").val("");
        },
    });
}

function setcorpus(filename, corpus) {

    post_data = { action: "setcorpus",  
        filename: filename,
        corpus: corpus };
    //console.log(post_data);

    $.ajax({
        url: "ajax-server.php",
        type: "POST",
        data: post_data,
        success: function(filename) {

                (async () => {

                    await nlp.addCorpus(document.location.href + filename);
                    await nlp.train();

                })();
            
                //alert("End Training");
        },
    });
}

function clear() {
    room = $("#room").text();
    //alert(room);
    if(room.trim() != "") {
        $.ajax({
            url: "ajax-server.php",
            type: "POST",
            data: { action: "clear", room: room },
            success: function(r) {
                $("#chat").html(r);
            }
        });
    }
}
    
function del() {
    room = $("#room").text();
    if(room == "default-chat") {
        alert("You cannot delete the default-chat");
        return;
    }
    //alert(room);
    if(room.trim() != "") {
        $.ajax({
            url: "ajax-server.php",
            type: "POST",
            data: { action: "delete", room: room },
            success: function(r) {
                $("#room").text("default-chat");
                $("#chat").html(r);
                room = "default-chat";
                get_room();
            }
        });
    }
}

function poll() {
    room = $("#room").text();
    if(room.trim() != "") {
        $.ajax({
            url: "ajax-server.php",
            type: "POST",
            data: { action: "poll", room: room },
            success: function(r) {
                $("#chat").html(r);
                // Added
                var ra = r.split("\n");

                if((ra.length-2) >= parseInt($("#prev").val())) {

                    var pos = Math.round(Math.random()*parseInt($("#prev").val()));

                } else {

                    var pos = Math.round(Math.random()*(ra.length-2));
                }

                var patt = new RegExp("</span>&nbsp;.*</p>$");
                
                try {
                    remark = patt.exec(ra[(ra.length-2)-pos])[0].replace("</span>&nbsp;","").replace("</p>", "");
                    //console.log(remark);
                } catch(e) {}
            }
        });
    }
    setTimeout(poll, 1000);
}

function get_room(create = false) {
    post_data = { action: "room" };
    if(create) {
        new_room = $("#name").text();
        new_room = new_room.replaceAll(' ', '-');
        new_room += "-" + Math.floor(Math.random() * Math.floor(10000));
        post_data["new"] = new_room;
    }
    console.log(post_data);
    
    $.ajax({
        url: "ajax-server.php",
        type: "POST",
        data: post_data,
        success: function(r) {
            console.log(r);
            obj = JSON.parse(r);
            list_rooms = "<option value='default-chat'>CHAT ROOM : default-chat</option>";
            for(id in obj) {
                
                if(obj[id] != "default-chat") {

                    list_rooms += "<option value='" + obj[id] + "'>CHAT ROOM : " + obj[id] + "</option>";
                }
            }
            //list_rooms += "<option value='create room'>======== CREATE A NEW ROOM ========</option>";
            
            $("#room-list").html(list_rooms).selectmenu("refresh", true);
            room = $("#room").text();
            if(room.trim() == "") {
                $("#room").text("default-chat");
            }
            if(create) {
                alert("CREATE A NEW ROOM : " + new_room);
                $("#room").text($("#room-list").find(":selected").val());
            }
        },
    });
}
</script>

